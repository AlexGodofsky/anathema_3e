def buildPlugin = {name, project, task ->
    task.archiveName = "${name}.jar"
    task.destinationDir = new File(buildDir, "plugins")
    task.dependsOn(":$project:assemble")
    task.dependsOn(":$project:collectTransitiveDependencies")
    task.from projectLibrary(project)
}

def exclude = ['Anathema']
project.subprojects.each {
    if (exclude.contains(it.name)){
        return;
    }
    def name = it.name.toLowerCase();
    def project = it.name
    task "build${project}Plugin"(type: Jar) {
        buildPlugin name, project, delegate
    }
}