<?xml version="1.0"?>
<project name="Common Targets" default="Purge">

	<property name="build.dir" location="build" />
	<property name="libraries.dir" location="${build.dir}/libraries" />
	<property name="plugins.dir" location="${build.dir}/plugins" />
	<property name="lib" value="./lib" />

	<target name="Purge">
		<delete dir="${build.dir}" />
	</target>

	<macrodef name="clean">
		<attribute name="module.name" />
		<sequential>
			<delete dir="${build.dir}/@{module.name}" />
		</sequential>
	</macrodef>

	<macrodef name="prepareModule">
		<attribute name="module.name" />
		<sequential>
			<mkdir dir="${build.dir}" />
			<mkdir dir="${plugins.dir}" />
			<mkdir dir="${library.dir}" />
			<mkdir dir="${module.dir}" />
			<mkdir dir="${class.dir}" />
			<mkdir dir="${resource.dir}" />
		</sequential>
	</macrodef>

	<macrodef name="buildModule">
		<attribute name="projectset" />
		<sequential>
			<foreach list="@{projectset}" target="Build project" param="project.name" />
		</sequential>
	</macrodef>

	<macrodef name="copyLibraries">
		<attribute name="projectset" />
		<sequential>
			<foreach list="${projectset}" target="Copy project libraries" param="project.name" />
		</sequential>
	</macrodef>

	<macrodef name="copyResources">
		<attribute name="projectset" />
		<sequential>
			<foreach list="${projectset}" target="Copy project resources" param="project.name" />
		</sequential>
	</macrodef>

	<macrodef name="compileClasspath">
		<attribute name="projectset" />
		<sequential>
			<copyLibraries projectset="@projectset" />
			<echo message="module.classpath=" file="${classpath.file}" append="false" />
			<foreach target="Add to path" param="jarfile">
				<path>
					<fileset dir="${library.dir}">
						<include name="*.jar" />
					</fileset>
				</path>
			</foreach>
		</sequential>
	</macrodef>

	<target name="Add to path">
		<basename property="jar.filename" file="${jarfile}" />
		<echo message=" ${lib}/${jar.filename}" file="${classpath.file}" append="true" />
	</target>

	<target name="Copy project resources">
		<copy todir="${resource.dir}" failonerror="false">
			<fileset dir="../${project.name}/resources">
				<include name="**/*" />
				<exclude name="**/*.xcf" />
				<exclude name="**/*.svg" />
				<exclude name="**/Thumbs.db" />
			</fileset>
		</copy>
	</target>

	<target name="Copy project libraries">
		<getEclipseClasspath property="classpath" workspace="${workspace.dir}" projectName="${project.name}" relative="false" initialiseWorkspace="true" />
		<foreach list="${classpath}" delimiter=";" target="Copy JAR" param="classpath.entry" />
	</target>

	<target name="Build project">
		<getEclipseClasspath property="classpath" workspace="${workspace.dir}" projectName="${project.name}" relative="false" initialiseWorkspace="true" />
		<executebuilders workspace="${workspace.dir}" projectName="${project.name}" />
	</target>

	<target name="javabuilder">
		<getSourcepath property="path" workspace="${workspace.dir}" projectName="${project.name}" allowMultipleFolders="true" />
		<javac classpath="${classpath}" srcdir="${path}" destdir="${class.dir}" debug="true" />
	</target>

	<target name="default-builder" />

	<target name="Copy JAR">
		<if>
			<and>
				<isfileselected file="${classpath.entry}">
					<filename name="**/*.jar" />
				</isfileselected>
				<or>
					<contains string="${classpath.entry}" substring="Database" />
					<contains string="${classpath.entry}" substring="disy" />
					<contains string="${classpath.entry}" substring="Jakarta" />
					<!--<contains string="${classpath.entry}" substring="GISterm" />-->
					<contains string="${classpath.entry}" substring="Multimedia" />
					<contains string="${classpath.entry}" substring="Plugin" />
					<contains string="${classpath.entry}" substring="Reporting" />
					<contains string="${classpath.entry}" substring="SVG" />
					<contains string="${classpath.entry}" substring="Swing" />
					<contains string="${classpath.entry}" substring="XML" />
				</or>
			</and>
			<then>
				<copy file="${classpath.entry}" todir="${library.dir}" />
			</then>
		</if>
	</target>
</project>